From 22f3cb1d8810bd3fa2a86c3aa64fcccc3b599f36 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Marek=20Marczykowski-G=C3=B3recki?=
 <marmarek@invisiblethingslab.com>
Date: Tue, 5 Jul 2022 13:51:47 +0200
Subject: [PATCH] tools/libxl: set 'trusted' property based on backend being
 dom0 or not

---
 tools/libxl/libxl_disk.c     | 3 +--
 tools/libxl/libxl_nic.c | 2 +-
 2 files changed, 2 insertions(+), 3 deletions(-)

diff --git a/tools/libxl/libxl_disk.c b/tools/libxl/libxl_disk.c
index 9a4c616..1878f34 100644
--- a/tools/libxl/libxl_disk.c
+++ b/tools/libxl/libxl_disk.c
@@ -395,8 +395,8 @@ static void device_disk_add(libxl__egc *egc, uint32_t domid,
         flexarray_append(front, disk->is_cdrom ? "cdrom" : "disk");
         flexarray_append(front, "trusted");
         envvar = getenv("LIBXL_DISK_BACKEND_UNTRUSTED");
-        /* Set "trusted=1" if envvar missing or is "0". */
+        /* Set "trusted=1" if envvar is "0". */
-        flexarray_append(front, !envvar || !strcmp("0", envvar) ? "1" : "0");
+        flexarray_append(front, disk->backend_domid ? (envvar && !strcmp("0", envvar) ? "1" : "0") : "1");
 
         /*
          * Old PV kernel disk frontends before 2.6.26 rely on tool stack to
diff --git a/tools/libxl/libxl_nic.c b/tools/libxl/libxl_nic.c
index d5577ca..271349b 100644
--- a/tools/libxl/libxl_nic.c
+++ b/tools/libxl/libxl_nic.c
@@ -232,8 +232,8 @@ static void libxl__device_nic_add(libxl__egc *egc, uint32_t domid,
 
     flexarray_append(front, "trusted");
     envvar = getenv("LIBXL_NIC_BACKEND_UNTRUSTED");
-    /* Set "trusted=1" if envvar missing or is "0". */
+    /* Set "trusted=1" if envvar is "0". */
-    flexarray_append(front, !envvar || !strcmp("0", envvar) ? "1" : "0");
+    flexarray_append(front, nic->backend_domid ? (envvar && !strcmp("0", envvar) ? "1" : "0") : "1");
 
     return 0;
 }
-- 
2.35.3


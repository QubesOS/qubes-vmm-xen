From d84e22ff2a88663e5dcb3cdced45faf2aac2fac1 Mon Sep 17 00:00:00 2001
From: Ross Lagerwall <ross.lagerwall@xxxxxxxxxx>
Date: Tue, 1 Dec 2015 16:57:46 +0000
Subject: [PATCH] x86/time: Don't use EFI's GetTime call by default

When EFI is used, don't use EFI's GetTime() to get the time, because it
is broken on many platforms. From Linux commit 7efe665903d0 ("rtc:
Disable EFI rtc for x86"):
"Disable it explicitly for x86 so that we don't give users false
hope that this driver will work - it won't, and your machine is likely
to crash."

Signed-off-by: Ross Lagerwall <ross.lagerwall@xxxxxxxxxx>
---
 xen/arch/x86/time.c | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/xen/arch/x86/time.c b/xen/arch/x86/time.c
index a97d78484105..45f6baf6270b 100644
--- a/xen/arch/x86/time.c
+++ b/xen/arch/x86/time.c
@@ -1552,6 +1552,9 @@ static const char *__init wallclock_type
     return "";
 }

+/* EFI's GetTime() is frequently broken so don't use it by default. */
+#undef USE_EFI_GET_TIME
+
 static void __init probe_wallclock(void)
 {
     ASSERT(wallclock_source == WALLCLOCK_UNSET);
@@ -1561,11 +1564,13 @@ static void __init probe_wallclock(void)
         wallclock_source = WALLCLOCK_XEN;
         return;
     }
+#ifdef USE_EFI_GET_TIME
     if ( efi_enabled(EFI_RS) && efi_get_time() )
     {
         wallclock_source = WALLCLOCK_EFI;
         return;
     }
+#endif
     if ( cmos_rtc_probe() )
     {
         wallclock_source = WALLCLOCK_CMOS;
-- 
2.44.0

